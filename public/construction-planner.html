<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suddeco Construction Planner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .header {
            background-color: #343a40;
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            text-align: center;
            border-radius: 0 0 10px 10px;
        }
        .card {
            margin-bottom: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #f1f5f9;
            font-weight: bold;
        }
        .task-card {
            transition: transform 0.2s;
        }
        .task-card:hover {
            transform: translateY(-5px);
        }
        .critical-path {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
        }
        .stage-header {
            background-color: #e3f2fd;
            padding: 10px 15px;
            margin: 15px 0 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .gantt-container {
            overflow-x: auto;
            margin-top: 20px;
            margin-bottom: 40px;
        }
        .timeline-info {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .badge-labor {
            background-color: #4caf50;
        }
        .badge-material {
            background-color: #2196f3;
        }
        .badge-qc {
            background-color: #ff9800;
        }
        .task-detail-toggle {
            cursor: pointer;
        }
        #gantt {
            margin-top: 20px;
        }
        .bar-critical .bar {
            fill: #f44336 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Suddeco Construction Planner</h1>
            <p>Detailed construction task breakdown and timeline visualization</p>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h2>Upload Drawing for Construction Planning</h2>
                    </div>
                    <div class="card-body">
                        <form id="upload-form" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="drawing" class="form-label">Upload Architectural Drawing</label>
                                <input type="file" class="form-control" id="drawing" name="drawing" accept=".pdf,.dxf,.dwg,.json">
                                <div class="form-text">Upload architectural drawings (PDF, DXF, DWG) or JSON data</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Generate Construction Plan</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading-section" style="display: none;">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h3 class="mt-3">Generating Construction Plan...</h3>
                <div class="progress mt-3">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                </div>
                <p class="text-muted mt-2">This may take a minute or two. We're analyzing the drawing and creating a detailed construction plan.</p>
            </div>
        </div>

        <div id="results-section" style="display: none;">
            <div class="timeline-info">
                <div class="row">
                    <div class="col-md-3">
                        <h5>Project Duration</h5>
                        <p id="project-duration" class="fs-4">0 days</p>
                    </div>
                    <div class="col-md-3">
                        <h5>Start Date</h5>
                        <p id="start-date" class="fs-4">-</p>
                    </div>
                    <div class="col-md-3">
                        <h5>End Date</h5>
                        <p id="end-date" class="fs-4">-</p>
                    </div>
                    <div class="col-md-3">
                        <h5>Critical Path Tasks</h5>
                        <p id="critical-path-count" class="fs-4">0</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>Project Timeline</h3>
                    <div>
                        <button id="view-day" class="btn btn-sm btn-outline-primary">Day</button>
                        <button id="view-week" class="btn btn-sm btn-outline-primary">Week</button>
                        <button id="view-month" class="btn btn-sm btn-outline-primary">Month</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="gantt-container">
                        <svg id="gantt"></svg>
                    </div>
                </div>
            </div>

            <h3 class="mt-4 mb-3">Construction Task Breakdown</h3>
            <div id="task-breakdown-container">
                <!-- Task breakdown will be dynamically generated here -->
            </div>

            <div class="text-center mt-4 mb-5">
                <a href="/" class="btn btn-outline-primary me-2">Back to Drawing Processor</a>
                <a id="download-plan" href="#" class="btn btn-success">Download Construction Plan</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadForm = document.getElementById('upload-form');
            const loadingSection = document.getElementById('loading-section');
            const resultsSection = document.getElementById('results-section');
            const progressBar = document.getElementById('progress-bar');
            const taskBreakdownContainer = document.getElementById('task-breakdown-container');
            const downloadPlanBtn = document.getElementById('download-plan');
            
            // Gantt chart view buttons
            const viewDayBtn = document.getElementById('view-day');
            const viewWeekBtn = document.getElementById('view-week');
            const viewMonthBtn = document.getElementById('view-month');
            
            // Timeline info elements
            const projectDurationEl = document.getElementById('project-duration');
            const startDateEl = document.getElementById('start-date');
            const endDateEl = document.getElementById('end-date');
            const criticalPathCountEl = document.getElementById('critical-path-count');
            
            let ganttChart = null;
            
            // Handle form submission
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(uploadForm);
                const fileInput = document.getElementById('drawing');
                
                if (!fileInput.files.length) {
                    alert('Please select a file to upload');
                    return;
                }
                
                // Show loading section
                loadingSection.style.display = 'block';
                resultsSection.style.display = 'none';
                
                // Simulate progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 1;
                    if (progress > 95) {
                        clearInterval(progressInterval);
                    }
                    progressBar.style.width = `${progress}%`;
                }, 300);
                
                // Send the file to the server
                fetch('/api/process-drawing', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    
                    setTimeout(() => {
                        loadingSection.style.display = 'none';
                        resultsSection.style.display = 'block';
                        
                        if (data.success && data.data.constructionPlan) {
                            // Display the construction plan
                            displayConstructionPlan(data.data.constructionPlan);
                            
                            // Set download link
                            if (data.data.reportUrls.constructionPlan) {
                                downloadPlanBtn.href = data.data.reportUrls.constructionPlan;
                                downloadPlanBtn.download = 'construction_plan.json';
                            } else {
                                downloadPlanBtn.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    const jsonStr = JSON.stringify(data.data.constructionPlan.taskBreakdown, null, 2);
                                    const blob = new Blob([jsonStr], { type: 'application/json' });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = 'construction_plan.json';
                                    document.body.appendChild(a);
                                    a.click();
                                    URL.revokeObjectURL(url);
                                    document.body.removeChild(a);
                                });
                            }
                        } else {
                            taskBreakdownContainer.innerHTML = `
                                <div class="alert alert-danger">
                                    <h4>Error Generating Construction Plan</h4>
                                    <p>${data.data.constructionPlan?.error || 'Unknown error occurred'}</p>
                                </div>
                            `;
                        }
                    }, 500);
                })
                .catch(error => {
                    clearInterval(progressInterval);
                    loadingSection.style.display = 'none';
                    alert('Error processing file: ' + error.message);
                    console.error('Error:', error);
                });
            });
            
            // Function to display the construction plan
            function displayConstructionPlan(constructionPlan) {
                // Update project timeline info
                const timeline = constructionPlan.timeline;
                projectDurationEl.textContent = `${timeline.projectDuration.toFixed(1)} days`;
                startDateEl.textContent = formatDate(timeline.estimatedStartDate);
                endDateEl.textContent = formatDate(timeline.estimatedEndDate);
                criticalPathCountEl.textContent = timeline.criticalPath.length;
                
                // Generate the Gantt chart
                generateGanttChart(constructionPlan.ganttChart);
                
                // Generate the task breakdown
                generateTaskBreakdown(constructionPlan.taskBreakdown);
            }
            
            // Function to generate the Gantt chart
            function generateGanttChart(ganttData) {
                const tasks = ganttData.tasks.map(task => ({
                    id: task.id,
                    name: task.name,
                    start: task.start,
                    end: task.end,
                    progress: task.progress,
                    dependencies: task.dependencies,
                    custom_class: task.isCritical ? 'bar-critical' : ''
                }));
                
                ganttChart = new Gantt("#gantt", tasks, {
                    header_height: 50,
                    column_width: 30,
                    step: 24,
                    view_modes: ['Day', 'Week', 'Month'],
                    bar_height: 20,
                    bar_corner_radius: 3,
                    arrow_curve: 5,
                    padding: 18,
                    view_mode: 'Week',
                    date_format: 'YYYY-MM-DD',
                    custom_popup_html: function(task) {
                        return `
                            <div class="popover fade show bs-popover-top" role="tooltip">
                                <div class="popover-body">
                                    <h6>${task.name}</h6>
                                    <p>Duration: ${getDuration(task.start, task.end)} days</p>
                                    <p>Start: ${formatDate(task.start)}</p>
                                    <p>End: ${formatDate(task.end)}</p>
                                    ${task.custom_class ? '<p class="text-danger"><strong>Critical Path Task</strong></p>' : ''}
                                </div>
                            </div>
                        `;
                    }
                });
                
                // Handle view mode buttons
                viewDayBtn.addEventListener('click', () => ganttChart.change_view_mode('Day'));
                viewWeekBtn.addEventListener('click', () => ganttChart.change_view_mode('Week'));
                viewMonthBtn.addEventListener('click', () => ganttChart.change_view_mode('Month'));
            }
            
            // Function to generate the task breakdown
            function generateTaskBreakdown(taskBreakdown) {
                let html = '';
                
                // Handle different task breakdown structures
                if (taskBreakdown.constructionStages) {
                    // If organized by construction stages
                    taskBreakdown.constructionStages.forEach(stage => {
                        html += `
                            <div class="stage-header">
                                <h4>${stage.stageName}</h4>
                            </div>
                        `;
                        
                        if (stage.tasks) {
                            html += '<div class="row">';
                            stage.tasks.forEach(task => {
                                const isCritical = task.isCriticalPath || false;
                                html += generateTaskCard(task, isCritical);
                            });
                            html += '</div>';
                        }
                    });
                } else if (taskBreakdown.tasks) {
                    // If organized as a flat list of tasks, group by stage
                    const stageMap = {};
                    
                    // Group tasks by stage
                    taskBreakdown.tasks.forEach(task => {
                        const stage = task.constructionStage || 'Other';
                        if (!stageMap[stage]) {
                            stageMap[stage] = [];
                        }
                        stageMap[stage].push(task);
                    });
                    
                    // Generate HTML for each stage
                    Object.keys(stageMap).forEach(stage => {
                        html += `
                            <div class="stage-header">
                                <h4>${stage}</h4>
                            </div>
                        `;
                        
                        html += '<div class="row">';
                        stageMap[stage].forEach(task => {
                            const isCritical = task.isCriticalPath || false;
                            html += generateTaskCard(task, isCritical);
                        });
                        html += '</div>';
                    });
                }
                
                taskBreakdownContainer.innerHTML = html;
                
                // Add event listeners for task detail toggles
                document.querySelectorAll('.task-detail-toggle').forEach(toggle => {
                    toggle.addEventListener('click', function() {
                        const detailsId = this.getAttribute('data-bs-target');
                        const detailsEl = document.querySelector(detailsId);
                        const isExpanded = this.getAttribute('aria-expanded') === 'true';
                        
                        if (isExpanded) {
                            this.setAttribute('aria-expanded', 'false');
                            detailsEl.classList.remove('show');
                        } else {
                            this.setAttribute('aria-expanded', 'true');
                            detailsEl.classList.add('show');
                        }
                    });
                });
            }
            
            // Function to generate a task card
            function generateTaskCard(task, isCritical) {
                const taskId = task.taskId;
                const collapseId = `collapse-${taskId.replace(/\s+/g, '-')}`;
                
                return `
                    <div class="col-md-6 mb-3">
                        <div class="card task-card ${isCritical ? 'critical-path' : ''}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">${task.taskName}</h5>
                                <span class="badge bg-${isCritical ? 'danger' : 'primary'}">${taskId}</span>
                            </div>
                            <div class="card-body">
                                <p>${task.description || 'No description available'}</p>
                                <div class="d-flex justify-content-between mb-2">
                                    <span><strong>Duration:</strong> ${task.estimatedDuration}</span>
                                    <span><strong>Labor:</strong> ${task.requiredLabor?.personDays || 'N/A'}</span>
                                </div>
                                
                                <div class="text-center mt-3">
                                    <button class="btn btn-sm btn-outline-secondary task-detail-toggle" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#${collapseId}" 
                                            aria-expanded="false" 
                                            aria-controls="${collapseId}">
                                        View Details
                                    </button>
                                </div>
                                
                                <div class="collapse mt-3" id="${collapseId}">
                                    <div class="card card-body">
                                        <h6>Dependencies</h6>
                                        <p>${formatDependencies(task.dependencies)}</p>
                                        
                                        <h6>Required Labor</h6>
                                        <ul class="list-group mb-3">
                                            ${formatLabor(task.requiredLabor)}
                                        </ul>
                                        
                                        <h6>Materials</h6>
                                        <ul class="list-group mb-3">
                                            ${formatMaterials(task.materialsUsed)}
                                        </ul>
                                        
                                        <h6>Quality Control</h6>
                                        <p>${formatQualityControl(task.qualityControlRequirements)}</p>
                                        
                                        ${task.roomDetails ? `
                                            <h6>Room/Location Details</h6>
                                            <p>${task.roomDetails}</p>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Helper functions for formatting
            function formatDependencies(dependencies) {
                if (!dependencies || dependencies.length === 0) {
                    return 'No dependencies';
                }
                
                if (Array.isArray(dependencies)) {
                    return dependencies.join(', ');
                }
                
                return dependencies;
            }
            
            function formatLabor(labor) {
                if (!labor) return 'No labor information available';
                
                let html = '';
                
                if (typeof labor === 'string') {
                    return `<li class="list-group-item">${labor}</li>`;
                }
                
                if (labor.trades && Array.isArray(labor.trades)) {
                    labor.trades.forEach(trade => {
                        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            ${trade.type || trade}
                            ${trade.quantity ? `<span class="badge badge-labor rounded-pill">${trade.quantity}</span>` : ''}
                        </li>`;
                    });
                } else if (typeof labor === 'object') {
                    Object.keys(labor).forEach(key => {
                        if (key !== 'personDays') {
                            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                ${key}
                                <span class="badge badge-labor rounded-pill">${labor[key]}</span>
                            </li>`;
                        }
                    });
                }
                
                return html || 'No labor information available';
            }
            
            function formatMaterials(materials) {
                if (!materials) return 'No materials information available';
                
                let html = '';
                
                if (typeof materials === 'string') {
                    return `<li class="list-group-item">${materials}</li>`;
                }
                
                if (Array.isArray(materials)) {
                    materials.forEach(material => {
                        if (typeof material === 'string') {
                            html += `<li class="list-group-item">${material}</li>`;
                        } else {
                            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                ${material.type || material.name}
                                ${material.quantity ? `<span class="badge badge-material rounded-pill">${material.quantity}</span>` : ''}
                            </li>`;
                        }
                    });
                } else if (typeof materials === 'object') {
                    Object.keys(materials).forEach(key => {
                        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            ${key}
                            <span class="badge badge-material rounded-pill">${materials[key]}</span>
                        </li>`;
                    });
                }
                
                return html || 'No materials information available';
            }
            
            function formatQualityControl(qc) {
                if (!qc) return 'No quality control information available';
                
                if (typeof qc === 'string') {
                    return qc;
                }
                
                if (Array.isArray(qc)) {
                    return qc.join('<br>');
                }
                
                if (typeof qc === 'object') {
                    let html = '<ul class="list-group">';
                    Object.keys(qc).forEach(key => {
                        html += `<li class="list-group-item">${key}: ${qc[key]}</li>`;
                    });
                    html += '</ul>';
                    return html;
                }
                
                return 'No quality control information available';
            }
            
            function formatDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            }
            
            function getDuration(startDate, endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            }
        });
    </script>
</body>
</html>
